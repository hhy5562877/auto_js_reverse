# CHANGELOG

- [2026-02-18 00:10] DOCS: 全面重写 README，完善 macOS/Linux/Windows 三平台部署教程 (Files: README.md, CHANGELOG)
  - 新增「前置工具安装」章节：macOS (Homebrew)、Linux (Ubuntu/Debian/CentOS/Fedora)、Windows (PowerShell/winget) 详细安装步骤
  - 环境要求改为表格形式，列出所有依赖及版本要求
  - Chrome 浏览器章节：新增各平台自动检测路径表格、手动启动增加 Linux 无桌面环境和 Windows PowerShell 命令、新增 CDP 连接验证方法
  - IDE 配置章节：所有 IDE (Cursor/Windsurf/Claude Code/VS Code/OpenCode) 均提供 macOS+Linux 和 Windows 两套完整配置示例
  - 常见问题重构为分类结构（连接问题/安装问题/运行问题/Linux 特有/macOS 特有/Windows 特有）
  - 新增 FAQ：CDP 连接超时排查、setuptools.backends 构建错误、npm install 失败、Docker 部署 Dockerfile 示例
  - 新增 FAQ：Linux 无桌面环境 Chrome 依赖库安装、macOS Gatekeeper 拦截、macOS lancedb x86_64 兼容
  - 新增 FAQ：Windows 路径过长、防火墙拦截 CDP 端口、Chrome 闪退排查
- [2026-02-18 00:00] FIX: 修复 Windows 下 uv run 构建失败的问题 (Files: pyproject.toml, CHANGELOG) [#1]
  - 根因: build-backend 配置为 `setuptools.backends._legacy:_Backend`，该模块为 setuptools 内部实验性 API，多数版本不存在
  - 修复: 改为标准 build-backend `setuptools.build_meta`
- [2026-02-17 23:49] DOCS: 完善 README Windows 部署教程 (Files: README.md, CHANGELOG)
  - 安装步骤新增 Windows PowerShell 和 CMD 两种命令示例（venv 激活、Node.js 依赖安装）
  - 环境变量设置新增 PowerShell `$env:` 和 CMD `set` 语法
  - IDE 配置章节补充 Windows 路径获取方式和 JSON 中路径转义说明
  - 其他 MCP 客户端启动命令新增 Windows PowerShell 和 CMD 版本
  - 常见问题新增 Windows 端口检查命令 `netstat -ano | findstr :9222`
  - 常见问题新增 Windows 下 uv 安装和 PowerShell 执行策略两个 FAQ
- [2026-02-16 23:54] FIX: 修复 CDP fallback 重试跳过可用标签页与 read_js_file 路径归一化异常问题 (Files: src/browser_insight/services/browser_connector.py, src/browser_insight/main.py, CHANGELOG)
  - connect() 新增 failed_debugger_urls 失败集合，重试时优先选择未失败过的 tab，穷尽后才允许重试历史失败 tab
  - 修复多标签场景下 A->B->A 的重复尝试问题，避免可用 tab 因重试顺序被跳过
  - read_js_file 对 Path.resolve(strict=False) 增加异常兜底，非法路径输入返回用户友好错误而非抛出未捕获异常
- [2026-02-16 19:45] FIX: 修复目标页连接语义回归与行号边界校验问题 (Files: src/browser_insight/services/browser_connector.py, src/browser_insight/main.py, doc/API.md, CHANGELOG)
  - ensure_connected(target_url) 在连接健康时新增目标页校验，不匹配时会自动导航到目标页面
  - _check_ws_alive 改为直接发送轻量 CDP ping，不再复用 _send_command，避免健康检查路径触发静默重连到非目标页
  - read_js_file 补充 start_line/end_line 的正数校验，并在 start_line 超出总行数时返回明确错误
  - doc/API.md 同步 read_js_file 的行号参数约束（>=1 且 end_line >= start_line）
- [2026-02-16 18:29] FIX: 按优先级修复本地文件读取安全、路径冲突与查询健壮性问题 (Files: src/browser_insight/main.py, src/browser_insight/services/pipeline.py, src/browser_insight/services/index_manager.py, pyproject.toml, doc/API.md, CHANGELOG)
  - read_js_file 增加安全边界：仅允许读取已归档且已登记索引的 JS 文件，拒绝任意本地路径与 .map 文件
  - read_js_file 增加行范围参数校验（end_line 不能小于 start_line）
  - capture_page 的 URL->本地路径映射增加 query/fragment 变体哈希，避免同路径不同 query 文件互相覆盖
  - capture_page 全流程增加 finally 清理，任意异常路径都保证执行浏览器断连
  - IndexManager where 条件统一使用安全字符串转义，修复包含单引号输入导致的查询失效风险
  - IndexManager 新增 get_file_by_local_path 供 read_js_file 做归档文件白名单校验
  - pyproject.toml 补充 aiohttp 运行时依赖声明
  - doc/API.md 同步 read_js_file 安全限制与参数语义
- [2026-02-16 17:48] FIX: 修复 BrowserConnector 在 websockets 新版本下连接判断异常及目标页回退误判问题 (Files: src/browser_insight/services/browser_connector.py, CHANGELOG)
  - is_connected/_check_ws_alive 改为使用兼容性状态判断，不再直接访问已在新版本中移除的 `self._ws.open`
  - 新增 _is_ws_open()，兼容 `state`(websockets>=14) 与 `open/closed`(legacy) 两类连接对象
  - connect() 目标页导航判定改为基于当前实际连接 tab URL，避免 fallback 后复用旧 tabs 快照导致跳过导航
  - 抽取 _url_matches_target() 统一 URL 匹配逻辑，减少目标页匹配分支重复
  - 通过本地内联回归脚本验证 state 型 WebSocket 兼容和 fallback tab 重新导航场景
- [2026-02-16 17:31] FIX: 增强 CDP 连接健壮性，解决连接超时和断线后无法恢复的问题 (Files: src/browser_insight/services/browser_connector.py, src/browser_insight/services/pipeline.py)
  - connect() 前先清理旧 WebSocket 连接，避免残留连接阻塞新连接
  - is_connected 改为检查 WebSocket 实际 open 状态，而非仅判断对象是否存在
  - 新增 _check_ws_alive() 健康检查，ensure_connected 时通过发送轻量 CDP 命令验证连接可用性
  - _ws_reader_loop 中 set_result 增加 Future 状态检查，防止 InvalidStateError
  - _ws_reader_loop 增加 JSON 解析容错，非 JSON 消息不再导致 reader 崩溃
  - _ws_connect 增加 10 秒连接超时，避免 WebSocket 握手无限等待
  - _send_command 断线重连后检查 WebSocket 状态，重连失败时抛出明确异常
  - _fetch_all_tabs 增加 3 次重试（间隔 1 秒），错误信息包含原始异常
  - connect() 重试时自动尝试备选标签页，WebSocket 被占用时切换到其他可用 tab
  - connect() 重试异常类型新增 asyncio.TimeoutError 捕获
  - navigate() 改为等待 Page.loadEventFired 事件，替代固定 sleep
  - disconnect() 增加 close 超时保护（3 秒）和 pending Future 取消
  - Pipeline.capture_page 改用 ensure_connected 替代 connect，支持连接复用
  - Pipeline.capture_page/shutdown 中 disconnect 增加异常保护，避免断线后报错
- [2026-02-16 17:02] FIX: 修复 OpenCode MCP 配置示例与新版 schema 不兼容导致启动报错的问题 (Files: README.md, CHANGELOG)
  - OpenCode 配置从旧版 `mcpServers + type=stdio + args + env[]` 更新为 `mcp + type=local + command[] + environment{}`
  - 文档补充 OpenCode 1.2+ 的字段约束，避免出现 `Invalid input mcp.browser-insight`
- [2026-02-16 16:00] FIX: 修复 Node.js Worker 解析压缩 JS 文件时内存爆炸导致 chunks_indexed=0 的问题 (Files: src/browser_insight/node_worker/processor.js)
  - 根因: 压缩文件(如 main-es5.js 3MB单行)的 AST 节点用行号切片时，每个节点都提取整行(=整个文件)，导致 6552 chunks × 3MB = 18.6GB
  - 修复: 检测压缩文件(平均行长 > 4000 字符)后，使用字符偏移(node.start/node.end)替代行号切片
  - 新增 chunkByChars() 按 4000 字符切分，MAX_CHUNK_CHARS=8000 防止单个 chunk 过大
  - 修复前: fenbi.com 9个文件 → JSON.stringify 失败 "Invalid string length"
  - 修复后: fenbi.com 9个文件 → 11,404 chunks, JSON 7.5MB, 解析成功
- [2026-02-16 15:48] FEAT: fenbi.com MCP 工具链集成测试，验证 8 个 MCP 工具的逆向辅助能力 (Files: tests/test_fenbi_mcp_tools.py)
  - 直接调用 MCP 工具函数(通过 FastMCP FunctionTool.fn)模拟 AI 使用工具进行逆向
  - 9 个步骤: capture → list → analyze → search → read → execute → hook → network → verify
  - 逆向结论: window.encrypt(publicKey, plaintext) → RSA(65537) → Base64, 登录 API: POST api/users/loginV2
- [2026-02-16 15:20] FIX: 修复多个工具在真实逆向场景中的可用性问题 (Files: src/browser_insight/services/browser_connector.py, src/browser_insight/services/embedding_service.py, src/browser_insight/main.py)
  - 重构 CDP WebSocket 消息路由：command 响应和 event 分离，解决 network capture 和 evaluate 互相干扰
  - capture_network_requests/hook_function 新增 trigger_action 参数，AI 可在监听期间自动触发操作
  - search_local_codebase 去重，避免返回重复代码片段
  - embedding_service 增加 429 限流自动重试（指数退避）
  - embedding_service 修复空文本导致 API 400 错误
- [2026-02-16 15:05] FEAT: 新增 6 个逆向分析 MCP 工具，完善 AI 自动逆向能力 (Files: src/browser_insight/main.py, src/browser_insight/services/browser_connector.py, src/browser_insight/services/index_manager.py, doc/API.md)
  - list_captured_files: 列出已抓取的 JS 文件列表
  - read_js_file: 读取 JS 文件源码（支持行范围）
  - execute_js: 在页面上下文执行 JS 表达式
  - capture_network_requests: CDP Network 域监听网络请求
  - hook_function: Hook 页面函数记录调用参数/返回值/调用栈
  - analyze_encryption: 自动扫描加密模式（MD5/AES/RSA/Base64/HMAC 等）
  - BrowserConnector 扩展: evaluate()、enable_network()、collect_network_events()
  - IndexManager 扩展: list_files_by_domain()、get_file_by_url()、search_chunks_by_text()
- [2026-02-16 12:45] REFACTOR: 所有运行时数据统一存储到 storage/ 目录下（数据库 storage/db、模型 storage/models、归档 storage/archives、Chrome 配置 storage/chrome_profile） (Files: .mcp_config/config.json, src/browser_insight/services/pipeline.py, src/browser_insight/services/embedding_service.py, src/browser_insight/services/browser_connector.py, .gitignore, README.md)
- [2026-02-16 12:39] FEAT: 端到端集成测试 (www.baidu.com)，覆盖 Chrome 检测、Node.js Worker、Embedding、IndexManager、完整管线五个环节 (Files: tests/test_e2e_baidu.py)
- [2026-02-16 12:39] FIX: NodeBridge stdout 流限制从 64KB 提升到 50MB，修复大量代码块解析时 LimitOverrunError (Files: src/browser_insight/services/node_bridge.py)
- [2026-02-16 12:39] CHORE: 补全 .gitignore，添加 Python 依赖 pandas/python-socks (Files: .gitignore, pyproject.toml)
- [2026-02-16 12:20] DOCS: README 重写 IDE 配置章节，统一使用 uv run 启动，覆盖 Cursor/Windsurf/Claude Code/VS Code 四种 IDE 的 JSON 配置方式 (Files: README.md)
- [2026-02-16 12:10] FEAT: capture_current_page 新增 storage_path 必填参数，由 AI 指定文件存储路径；存储结构改为 {storage_path}/{日期}/{域名}/{原始URL路径}，保留网站原始目录结构 (Files: src/browser_insight/main.py, src/browser_insight/services/pipeline.py, doc/API.md, README.md)
- [2026-02-16 12:00] FEAT: Chrome 自动启动功能，未检测到远程调试端口时自动查找并启动本机浏览器 (Files: src/browser_insight/services/browser_connector.py, src/browser_insight/services/pipeline.py, .mcp_config/config.json, README.md)
  - 支持自动检测 Chrome/Chromium/Brave/Edge
  - 支持 headless 无头模式
  - 独立用户数据目录，不影响日常 Chrome 配置
  - 可通过 auto_launch 配置项关闭
- [2026-02-16 11:50] DOCS: 添加 README 使用文档，包含 Claude Code/Cursor/通用 MCP 客户端接入方式和 hf-mirror 镜像配置 (Files: README.md)
- [2026-02-16 11:38] FEAT: 初始化 Browser Insight Hybrid MCP 项目，实现完整的混合架构 (Files: pyproject.toml, .mcp_config/config.json, src/browser_insight/node_worker/package.json, src/browser_insight/node_worker/processor.js, src/browser_insight/services/browser_connector.py, src/browser_insight/services/node_bridge.py, src/browser_insight/services/index_manager.py, src/browser_insight/services/embedding_service.py, src/browser_insight/services/pipeline.py, src/browser_insight/main.py)
  - Node.js Worker: source-map 高保真还原 + acorn AST 语义切分
  - Python BrowserConnector: CDP WebSocket 连接、资源发现、脚本下载
  - Python NodeBridge: Node.js 子进程常驻管理、stdin/stdout JSON 行协议通信
  - Python IndexManager: LanceDB 哈希去重 + 向量检索
  - Python EmbeddingService: FastEmbed ONNX 轻量向量化
  - Python Pipeline: 完整数据管线（抓取→归档→解析→向量化→入库）
  - FastMCP Server: capture_current_page / search_local_codebase / list_archived_sites
- [2026-02-16 11:38] DOCS: 创建 API 文档和 CHANGELOG (Files: doc/API.md, CHANGELOG)
